<!DOCTYPE html>
<mat-card class="requests-container mat-elevation-z8">
  <div class="header-row">
    <h2 class="page-title">
      <mat-icon class="title-icon">build</mat-icon>
      Maintenance Requests
    </h2>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Filter by Status</mat-label>
      <mat-select [(value)]="selectedStatus" (selectionChange)="applyFilter()">
        <mat-option value="all" class="options-select">All Requests</mat-option>
        <mat-option value="pending" class="options-select">Pending</mat-option>
        <mat-option value="approved" class="options-select">Approved</mat-option>
        <mat-option value="rejected" class="options-select">Rejected</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div *ngIf="loading" class="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading requests...</p>
  </div>

  <div *ngIf="!loading">
    <div class="table-container">
      <table mat-table [dataSource]="filteredRequests" class="mat-elevation-z4 full-width-table">

        <!-- ID Column -->
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>ID</th>
          <td mat-cell *matCellDef="let r" class="request-id">{{ r.id }}</td>
        </ng-container>

        <!-- Device ID Column -->
        <ng-container matColumnDef="deviceId">
          <th mat-header-cell *matHeaderCellDef>Device ID</th>
          <td mat-cell *matCellDef="let r">{{ r.deviceId }}</td>
        </ng-container>

        <!-- Old Serial Column -->
        <ng-container matColumnDef="oldSerial">
          <th mat-header-cell *matHeaderCellDef>Old Serial</th>
          <td mat-cell *matCellDef="let r" class="serial-number">
            <code>{{ r.oldSerial }}</code>
          </td>
        </ng-container>

        <!-- New Serial Column -->
        <ng-container matColumnDef="newSerial">
          <th mat-header-cell *matHeaderCellDef>New Serial</th>
          <td mat-cell *matCellDef="let r" class="serial-number">
            <code>{{ r.displayNewSerial }}</code>
          </td>
        </ng-container>

        <!-- Request Type Column -->
        <ng-container matColumnDef="requestType">
          <th mat-header-cell *matHeaderCellDef>Request Type</th>
          <td mat-cell *matCellDef="let r">
            <span class="type-badge" [style.background-color]="getRequestTypeColor(r.requestType)">
              {{ r.requestType | titlecase }}
            </span>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let r">
            <mat-chip [ngClass]="'status-chip status-' + r.normalizedStatus" class="status-chip">
              <mat-icon class="chip-icon">{{ getStatusIcon(r.status) }}</mat-icon>
              {{ r.status | titlecase }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Created By Column -->
        <ng-container matColumnDef="createdBy">
          <th mat-header-cell *matHeaderCellDef>Created By</th>
          <td mat-cell *matCellDef="let r">{{ r.createdBy }}</td>
        </ng-container>

        <!-- Approved By Column -->
        <ng-container matColumnDef="approvedBy">
          <th mat-header-cell *matHeaderCellDef>Approved By</th>
          <td mat-cell *matCellDef="let r">{{ r.displayApprovedBy }}</td>
        </ng-container>

        <!-- Reference ID Column -->
        <ng-container matColumnDef="referenceId">
          <th mat-header-cell *matHeaderCellDef>Reference ID</th>
          <td mat-cell *matCellDef="let r" class="reference-id">
            <code>{{ r.referenceId }}</code>
          </td>
        </ng-container>

        <!-- Remarks Column -->
        <ng-container matColumnDef="remarks">
          <th mat-header-cell *matHeaderCellDef>Remarks</th>
          <td mat-cell *matCellDef="let r" class="remarks-cell">
            {{ r.displayRemarks }}
          </td>
        </ng-container>

        <!-- Created At Column -->
        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>Created At</th>
          <td mat-cell *matCellDef="let r">{{ r.formattedCreatedAt }}</td>
        </ng-container>

        <!-- Updated At Column -->
        <ng-container matColumnDef="updatedAt">
          <th mat-header-cell *matHeaderCellDef>Updated At</th>
          <td mat-cell *matCellDef="let r">{{ r.formattedUpdatedAt }}</td>
        </ng-container>

        <!-- Admin Actions Column -->
        <ng-container *ngIf="isAdmin()" matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header">Actions</th>
          <td mat-cell *matCellDef="let r">
            <div class="action-buttons" *ngIf="canPerformAction(r); else statusInfo">
              <button
                mat-icon-button
                color="primary"
                class="approve-btn circular-btn"
                (click)="confirmAction(r, true)"
                [disabled]="actionInProgress === r.id"
                matTooltip="Approve Request">
                <mat-icon>{{ actionInProgress === r.id ? 'hourglass_empty' : 'check_circle' }}</mat-icon>
              </button>

              <button
                mat-icon-button
                color="warn"
                class="reject-btn circular-btn"
                (click)="confirmAction(r, false)"
                [disabled]="actionInProgress === r.id"
                matTooltip="Reject Request">
                <mat-icon>{{ actionInProgress === r.id ? 'hourglass_empty' : 'cancel' }}</mat-icon>
              </button>
            </div>
            <ng-template #statusInfo>
              <div class="status-info">
                <mat-icon [color]="r.normalizedStatus === 'approved' ? 'primary' : 'warn'">
                  {{ getStatusIcon(r.status) }}
                </mat-icon>
                <span>{{ r.status | titlecase }}</span>
              </div>
            </ng-template>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            [ngClass]="{'pending-row': row.normalizedStatus === 'pending'}"></tr>
      </table>
    </div>

    <!-- Empty State -->
    <div *ngIf="filteredRequests.length === 0" class="no-data">
      <mat-icon class="no-data-icon">inventory_2</mat-icon>
      <h3>No maintenance requests found</h3>
      <p *ngIf="selectedStatus !== 'all'">
        No requests match the current filter. Try changing your filter criteria.
      </p>
      <p *ngIf="selectedStatus === 'all'">
        There are no maintenance requests in the system yet.
      </p>
      <button *ngIf="selectedStatus !== 'all'" mat-raised-button color="primary" (click)="clearFilter()">
        Clear Filter
      </button>
    </div>

    <!-- Summary Stats -->
    <div *ngIf="requests.length > 0" class="summary-stats">
      <mat-card class="stat-card total-stat">
        <mat-card-content>
          <div class="stat-item">
            <span class="stat-number">{{ requests.length }}</span>
            <span class="stat-label">Total</span>
          </div>
        </mat-card-content>
      </mat-card>
      <mat-card class="stat-card pending-stat">
        <mat-card-content>
          <div class="stat-item">
            <span class="stat-number">{{ getRequestsByStatus('pending').length }}</span>
            <span class="stat-label">Pending</span>
          </div>
        </mat-card-content>
      </mat-card>
      <mat-card class="stat-card approved-stat">
        <mat-card-content>
          <div class="stat-item">
            <span class="stat-number">{{ getRequestsByStatus('approved').length }}</span>
            <span class="stat-label">Approved</span>
          </div>
        </mat-card-content>
      </mat-card>
      <mat-card class="stat-card rejected-stat">
        <mat-card-content>
          <div class="stat-item">
            <span class="stat-number">{{ getRequestsByStatus('rejected').length }}</span>
            <span class="stat-label">Rejected</span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</mat-card>
